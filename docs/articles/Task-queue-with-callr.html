<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>A multi process task queue in 100 lines of R code • callr</title>
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js" integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha256-916EbMg70RQy9LHiGkXzG8hSg9EdNy97GazNG/aiY1w=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha256-U5ZEeKfGNOja007MMD3YBI0A3OSZOQbeG6z2f2Y0hu8=" crossorigin="anonymous"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" integrity="sha256-eZrrJcwDc/3uDhsdt61sL2oOBY362qM3lon1gyExkL0=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.4/clipboard.min.js" integrity="sha256-FiZwavyI2V6+EXO1U+xzLG3IKldpiTFf3153ea9zikQ=" crossorigin="anonymous"></script><!-- sticky kit --><script src="https://cdnjs.cloudflare.com/ajax/libs/sticky-kit/1.1.3/sticky-kit.min.js" integrity="sha256-c4Rlo1ZozqTPE2RLuvbusY3+SU1pQaJC0TjuhygMipw=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="A multi process task queue in 100 lines of R code">
<meta property="og:description" content="">
<meta name="twitter:card" content="summary">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">callr</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">3.3.0</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fa fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Task-queue-with-callr.html">A multi process task queue in 100 lines of R code</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/r-lib/callr">
    <span class="fa fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      
      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1>A multi process task queue in 100 lines of R code</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/r-lib/callr/blob/master/vignettes/Task-queue-with-callr.Rmd"><code>vignettes/Task-queue-with-callr.Rmd</code></a></small>
      <div class="hidden name"><code>Task-queue-with-callr.Rmd</code></div>

    </div>

    
    
<div id="introduction" class="section level2">
<h2 class="hasAnchor">
<a href="#introduction" class="anchor"></a>Introduction</h2>
<p>This post is a demo of <code><a href="../reference/r_session.html">callr::r_session</a></code>, a persistent R session you can use to run R code asynchronously. I set out to build a task queue, which runs tasks in subprocesses, concurrently, in mere 100 lines of R code.</p>
<p>Here is a short teaser for how the queue will work. <code>task_q$new()</code> creates a new R6 object, which represents the queue. Its <code>push()</code> method adds a task, which is a function and its arguments, similarly to <code><a href="../reference/r.html">callr::r()</a></code>. The <code>pop()</code> method gets the results of the first task that has finished. <code>pop()</code> has a timeout argument, which lets you wait for a task to finish, if all pushed tasks are still running. It returns <code>NULL</code> if no task has finished before the timeout was over. The timeout can be <code>0</code> or <code>Inf</code>, meaning no wait at all, or wait indefinitely. The default timeout is <code>0</code>.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb1-1" data-line-number="1">q &lt;-<span class="st"> </span>task_q<span class="op">$</span><span class="kw">new</span>()</a>
<a class="sourceLine" id="cb1-2" data-line-number="2">q<span class="op">$</span><span class="kw">push</span>(<span class="cf">function</span>() { <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.getpid">Sys.getpid</a></span>() })</a>
<a class="sourceLine" id="cb1-3" data-line-number="3">q<span class="op">$</span><span class="kw">push</span>(<span class="cf">function</span>() { <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.sleep">Sys.sleep</a></span>(.<span class="dv">5</span>); <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.getpid">Sys.getpid</a></span>() })</a>
<a class="sourceLine" id="cb1-4" data-line-number="4">q<span class="op">$</span><span class="kw">pop</span>()</a>
<a class="sourceLine" id="cb1-5" data-line-number="5"><span class="co">#&gt; NULL</span></a></code></pre></div>
<p>This <code>pop()</code> call returned <code>NULL</code>, as none of the tasks are done yet. Even though running <code><a href="https://www.rdocumentation.org/packages/base/topics/Sys.getpid">Sys.getpid()</a></code> is fast, the worker processes also need 200-500 ms time start up, when the queue is created. If you are willing to wait a bit, at least one task should be done in less than half a second, but usually not the second one yet:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb2-1" data-line-number="1">sec &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/difftime">as.difftime</a></span>(<span class="dv">1</span>, <span class="dt">units =</span> <span class="st">"secs"</span>)</a>
<a class="sourceLine" id="cb2-2" data-line-number="2">q<span class="op">$</span><span class="kw">pop</span>(sec <span class="op">*</span><span class="st"> </span><span class="dv">1</span><span class="op">/</span><span class="dv">2</span>)<span class="op">$</span>result</a>
<a class="sourceLine" id="cb2-3" data-line-number="3"><span class="co">#&gt; [1] 996</span></a>
<a class="sourceLine" id="cb2-4" data-line-number="4">q<span class="op">$</span><span class="kw">pop</span>()</a>
<a class="sourceLine" id="cb2-5" data-line-number="5"><span class="co">#&gt; NULL</span></a></code></pre></div>
<p>The <code><a href="http://processx.r-lib.org/reference/poll.html">poll()</a></code> method checks for finished tasks without removing their results from the queue. It also has a timeout parameter, which works the same way as <code>pop()</code>’s timeout. <code><a href="http://processx.r-lib.org/reference/poll.html">poll()</a></code> returns the identifiers of all tasks that are done.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb3-1" data-line-number="1">q<span class="op">$</span><span class="kw"><a href="http://processx.r-lib.org/reference/poll.html">poll</a></span>(<span class="ot">Inf</span>)</a>
<a class="sourceLine" id="cb3-2" data-line-number="2"><span class="co">#&gt; [1] ".2"</span></a>
<a class="sourceLine" id="cb3-3" data-line-number="3">q<span class="op">$</span><span class="kw">pop</span>()<span class="op">$</span>result</a>
<a class="sourceLine" id="cb3-4" data-line-number="4"><span class="co">#&gt; [1] 997</span></a></code></pre></div>
<p>If the queue is empty, i.e. not tasks are running and no tasks are waiting, then <code>pop()</code> always returns <code>NULL</code>, immediately, because there is nothing to wait for:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb4-1" data-line-number="1">q<span class="op">$</span><span class="kw">pop</span>()</a>
<a class="sourceLine" id="cb4-2" data-line-number="2"><span class="co">#&gt; NULL</span></a></code></pre></div>
</div>
<div id="api-design" class="section level2">
<h2 class="hasAnchor">
<a href="#api-design" class="anchor"></a>API design</h2>
<p>The task queue will be an R6 class, with <code>push()</code>, <code>pop()</code>, <code><a href="http://processx.r-lib.org/reference/poll.html">poll()</a></code> methods like above, and some other query methods:</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb5-1" data-line-number="1">task_q &lt;-<span class="st"> </span>R6<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/R6/topics/R6Class">R6Class</a></span>(</a>
<a class="sourceLine" id="cb5-2" data-line-number="2">  <span class="st">"task_q"</span>,</a>
<a class="sourceLine" id="cb5-3" data-line-number="3">  <span class="dt">public =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(</a>
<a class="sourceLine" id="cb5-4" data-line-number="4">    <span class="dt">initialize      =</span> <span class="cf">function</span>(<span class="dt">concurrency =</span> 4L) { },</a>
<a class="sourceLine" id="cb5-5" data-line-number="5">    <span class="dt">get_num_waiting =</span> <span class="cf">function</span>() { },</a>
<a class="sourceLine" id="cb5-6" data-line-number="6">    <span class="dt">get_num_running =</span> <span class="cf">function</span>() { },</a>
<a class="sourceLine" id="cb5-7" data-line-number="7">    <span class="dt">get_num_done    =</span> <span class="cf">function</span>() { },</a>
<a class="sourceLine" id="cb5-8" data-line-number="8">    <span class="dt">is_idle         =</span> <span class="cf">function</span>() { },</a>
<a class="sourceLine" id="cb5-9" data-line-number="9">    <span class="dt">list_tasks      =</span> <span class="cf">function</span>() { },</a>
<a class="sourceLine" id="cb5-10" data-line-number="10"></a>
<a class="sourceLine" id="cb5-11" data-line-number="11">    <span class="dt">push =</span> <span class="cf">function</span>(fun, <span class="dt">args =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(), <span class="dt">id =</span> <span class="ot">NULL</span>) { },</a>
<a class="sourceLine" id="cb5-12" data-line-number="12">    <span class="dt">poll =</span> <span class="cf">function</span>(<span class="dt">timeout =</span> <span class="dv">0</span>) { },</a>
<a class="sourceLine" id="cb5-13" data-line-number="13">    <span class="dt">pop =</span> <span class="cf">function</span>(<span class="dt">timeout =</span> <span class="dv">0</span>) { }</a>
<a class="sourceLine" id="cb5-14" data-line-number="14">  )</a>
<a class="sourceLine" id="cb5-15" data-line-number="15">)</a></code></pre></div>
<p><code>initialize()</code> has an argument to set the number of workers, for this queue the size of the worker pool remains fixed for the lifetime of the queue.</p>
<p>The <code>get_num_*()</code> methods return the number of waiting, running and completed tasks. <code>get_num_done()</code> includes tasks that haven’t been <code>pop()</code>-d yet. Once a task is <code>pop()</code>-d, it is removed completely from the queue.</p>
<p><code>is_idle()</code> returns <code>TRUE</code> if the queue does not have any tasks (in any state). <code>list_tasks()</code> returns a data frame (tibble) with data about the tasks. This is especially useful for debugging.</p>
<p><code>push()</code> adds a task to the queue. <code><a href="http://processx.r-lib.org/reference/poll.html">poll()</a></code> returns the ids of all tasks that are done. <code>pop()</code> returns the result of the oldest task that is done.</p>
</div>
<div id="data-structure" class="section level2">
<h2 class="hasAnchor">
<a href="#data-structure" class="anchor"></a>Data structure</h2>
<p>Before writing the methods, I’ll need to design the data structure to store all information about the tasks and the worker processes. The standard data structure for a list of records is a data frame in R. Perhaps for many the first choice would be to keep a data frame for the tasks, and another one for the workers, assign ids to both tasks and processes and reference tasks by their ids in the worker data frame (i.e. which task is this worker running?) and vice-versa.</p>
<p>I’ll go a step further here, and store both the tasks and the workers <em>in the same</em> data frame. This will simplify the implementation considerably. The queue will create a dummy <em>idle</em> task for each worker. The worker will (pretend to) run this task if there are no other, real tasks waiting. The task list will always contain at least as many tasks as the number of workers in the queue.</p>
<p>An example for a task data frame:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb6-1" data-line-number="1">q<span class="op">$</span><span class="kw">list_tasks</span>()</a>
<a class="sourceLine" id="cb6-2" data-line-number="2"><span class="co">#&gt; # A tibble: 9 x 7</span></a>
<a class="sourceLine" id="cb6-3" data-line-number="3"><span class="co">#&gt;   id      idle  state   fun    args       worker     result</span></a>
<a class="sourceLine" id="cb6-4" data-line-number="4"><span class="co">#&gt;   &lt;chr&gt;   &lt;lgl&gt; &lt;chr&gt;   &lt;list&gt; &lt;list&gt;     &lt;list&gt;     &lt;list&gt;</span></a>
<a class="sourceLine" id="cb6-5" data-line-number="5"><span class="co">#&gt; 1 .11     FALSE running &lt;fn&gt;   &lt;list [1]&gt; &lt;r_sessin&gt; &lt;NULL&gt;</span></a>
<a class="sourceLine" id="cb6-6" data-line-number="6"><span class="co">#&gt; 2 .12     FALSE running &lt;fn&gt;   &lt;list [1]&gt; &lt;r_sessin&gt; &lt;NULL&gt;</span></a>
<a class="sourceLine" id="cb6-7" data-line-number="7"><span class="co">#&gt; 3 .13     FALSE running &lt;fn&gt;   &lt;list [1]&gt; &lt;r_sessin&gt; &lt;NULL&gt;</span></a>
<a class="sourceLine" id="cb6-8" data-line-number="8"><span class="co">#&gt; 4 .14     FALSE running &lt;fn&gt;   &lt;list [1]&gt; &lt;r_sessin&gt; &lt;NULL&gt;</span></a>
<a class="sourceLine" id="cb6-9" data-line-number="9"><span class="co">#&gt; 5 .15     FALSE waiting &lt;fn&gt;   &lt;list [1]&gt; &lt;NULL&gt;     &lt;NULL&gt;</span></a>
<a class="sourceLine" id="cb6-10" data-line-number="10"><span class="co">#&gt; 6 .idle-1 TRUE  waiting &lt;NULL&gt; &lt;NULL&gt;     &lt;NULL&gt;     &lt;NULL&gt;</span></a>
<a class="sourceLine" id="cb6-11" data-line-number="11"><span class="co">#&gt; 7 .idle-2 TRUE  waiting &lt;NULL&gt; &lt;NULL&gt;     &lt;NULL&gt;     &lt;NULL&gt;</span></a>
<a class="sourceLine" id="cb6-12" data-line-number="12"><span class="co">#&gt; 8 .idle-3 TRUE  waiting &lt;NULL&gt; &lt;NULL&gt;     &lt;NULL&gt;     &lt;NULL&gt;</span></a>
<a class="sourceLine" id="cb6-13" data-line-number="13"><span class="co">#&gt; 9 .idle-4 TRUE  waiting &lt;NULL&gt; &lt;NULL&gt;     &lt;NULL&gt;     &lt;NULL&gt;</span></a></code></pre></div>
<p>The columns are:</p>
<ul>
<li>
<code>id</code>: a character id, which can be user-supplied or auto-assigned (if the user did not supply it). This is useful to identify tasks.</li>
<li>
<code>idle</code>: a logical flag, whether this is a dummy idle task or not.</li>
<li>
<code>state</code>: current state of the task. More about this shortly.</li>
<li>
<code>fun</code>: the function the task needs to run. This is a list column.</li>
<li>
<code>args</code>: arguments to pass to the function. This is a list itself, so the column is a list column.</li>
<li>
<code>worker</code>: the <code><a href="../reference/r_session.html">callr::r_session</a></code> object, the R session that is running the task, or <code>NULL</code> if the task is not running.</li>
<li>
<code>result</code>: another list column, the result of the run, if the task is already done, <code>NULL</code> otherwise.</li>
</ul>
<p>The possible task states are: <em>waiting</em>, <em>running</em>, <em>ready</em> and <em>done</em>. The first two are not very surprising. The distinction between the last two is somewhat technical. A task is <em>ready</em> if the background R session has finished running it. The queue hasn’t read out its result yet, and the R session is still assigned to it. (I.e. the task’s <code>worker</code> column is not <code>NULL</code>.) A task is <em>done</em> if the queue has already read out the result of the function call, and has reassigned the R session to another task, so its <code>worker</code> column is <code>NULL</code>.</p>
<p>Tasks that are <em>running</em> and <em>ready</em> always have an R session assigned to them. Since all R sessions are always assigned to tasks (dummy idle tasks, if there is nothing else), this means the that the sum of the <em>running</em> and <em>ready</em> tasks always equals the number of workers.</p>
<p>The idle tasks are somewhat special, because they are never <em>done</em>. If an idle task is <em>ready</em> and its worker is reassigned, it will be <em>waiting</em> again. They are also almost never in the <em>running</em> state. When the queue assigns a worker to an idle task, the task will immediately go into the <em>ready</em> state, since the queue is immediately allowed to re-assign the worker, should a real task be <em>waiting</em>.</p>
<p>However, when a worker is starting up, its idle task is <em>running</em>, until their background R process has started up. After this initial <em>running</em> state the idle tasks are always either <em>waiting</em> or <em>ready</em>.</p>
</div>
<div id="implementation" class="section level2">
<h2 class="hasAnchor">
<a href="#implementation" class="anchor"></a>Implementation</h2>
<p>I am ready to start the implementation now. I’ll focus on the individual methods here, and show the complete code of the R6 class at the end. Let’s start with the internal data. <code>tasks</code> contains the task data frame, <code>initialize()</code> will create it. <code>next_id</code> and <code>get_next_id</code> will provide us unique task ids. I prefix these with a dot, to increase the probability that they won’t interfere with user supplied task ids. So they’ll be <code>".1"</code>, <code>".2"</code>, etc.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb7-1" data-line-number="1">  private =<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(</a>
<a class="sourceLine" id="cb7-2" data-line-number="2">    <span class="dt">tasks =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb7-3" data-line-number="3">    <span class="dt">next_id =</span> 1L,</a>
<a class="sourceLine" id="cb7-4" data-line-number="4">    <span class="dt">get_next_id =</span> <span class="cf">function</span>() {</a>
<a class="sourceLine" id="cb7-5" data-line-number="5">      id &lt;-<span class="st"> </span>private<span class="op">$</span>next_id</a>
<a class="sourceLine" id="cb7-6" data-line-number="6">      private<span class="op">$</span>next_id &lt;-<span class="st"> </span>id <span class="op">+</span><span class="st"> </span>1L</a>
<a class="sourceLine" id="cb7-7" data-line-number="7">      <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">"."</span>, id)</a>
<a class="sourceLine" id="cb7-8" data-line-number="8">    }</a>
<a class="sourceLine" id="cb7-9" data-line-number="9">  )</a></code></pre></div>
<p>The <code>initialize()</code> method will just defer the work to a private method and return the object itself. Returning <code>self</code> is usually good practice and allows method chaining, although most <code>task_q</code> method do not return <code>self</code>, limiting this considerably.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb8-1" data-line-number="1">    initialize =<span class="st"> </span><span class="cf">function</span>(<span class="dt">concurrency =</span> 4L) {</a>
<a class="sourceLine" id="cb8-2" data-line-number="2">      private<span class="op">$</span><span class="kw">start_workers</span>(concurrency)</a>
<a class="sourceLine" id="cb8-3" data-line-number="3">      <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/invisible">invisible</a></span>(self)</a>
<a class="sourceLine" id="cb8-4" data-line-number="4">    }</a></code></pre></div>
<p>The private <code>start_workers()</code> method that actually starts the workers and creates the <code>tasks</code> data frame:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb9-1" data-line-number="1">    start_workers =<span class="st"> </span><span class="cf">function</span>(concurrency) {</a>
<a class="sourceLine" id="cb9-2" data-line-number="2">      private<span class="op">$</span>tasks &lt;-<span class="st"> </span>tibble<span class="op">::</span><span class="kw"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span>(</a>
<a class="sourceLine" id="cb9-3" data-line-number="3">        <span class="dt">id =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/character">character</a></span>(), <span class="dt">idle =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/logical">logical</a></span>(),</a>
<a class="sourceLine" id="cb9-4" data-line-number="4">        <span class="dt">state =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"waiting"</span>, <span class="st">"running"</span>, <span class="st">"ready"</span>, <span class="st">"done"</span>)[<span class="ot">NULL</span>],</a>
<a class="sourceLine" id="cb9-5" data-line-number="5">        <span class="dt">fun =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(), <span class="dt">args =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(), <span class="dt">worker =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(), <span class="dt">result =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>())</a>
<a class="sourceLine" id="cb9-6" data-line-number="6">      <span class="cf">for</span> (i <span class="cf">in</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq_len</a></span>(concurrency)) {</a>
<a class="sourceLine" id="cb9-7" data-line-number="7">        rs &lt;-<span class="st"> </span>callr<span class="op">::</span>r_session<span class="op">$</span><span class="kw">new</span>(<span class="dt">wait =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb9-8" data-line-number="8">        private<span class="op">$</span>tasks &lt;-<span class="st"> </span>tibble<span class="op">::</span><span class="kw"><a href="https://tibble.tidyverse.org/reference/add_row.html">add_row</a></span>(private<span class="op">$</span>tasks,</a>
<a class="sourceLine" id="cb9-9" data-line-number="9">          <span class="dt">id =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">".idle-"</span>, i), <span class="dt">idle =</span> <span class="ot">TRUE</span>, <span class="dt">state =</span> <span class="st">"running"</span>,</a>
<a class="sourceLine" id="cb9-10" data-line-number="10">          <span class="dt">fun =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="ot">NULL</span>), <span class="dt">args =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="ot">NULL</span>), <span class="dt">worker =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(rs),</a>
<a class="sourceLine" id="cb9-11" data-line-number="11">          <span class="dt">result =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="ot">NULL</span>))</a>
<a class="sourceLine" id="cb9-12" data-line-number="12">      }</a>
<a class="sourceLine" id="cb9-13" data-line-number="13">    }</a></code></pre></div>
<p>The starting values of the empty task data frame are mostly straightforward. If you are wondering about the indexing with <code>NULL</code> here, it is a simple way to list all possible task states in the code, in one place, as a note for the code reader.</p>
<p><code>callr::r_session$new()</code> starts a background R process. The <code>wait = FALSE</code> argument tells callr <em>not</em> to wait until the process is ready to run R code. This way the R processes start up in parallel, which is worth the trouble of making our dummy tasks a bit more complicated. The idle tasks are named <code>.idle-*</code>. After initialization, the workers are started, and the <em>running</em> idle tasks are added to the data frame.</p>
<p>The query methods are next:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb10-1" data-line-number="1">    list_tasks =<span class="st"> </span><span class="cf">function</span>() private<span class="op">$</span>tasks,</a>
<a class="sourceLine" id="cb10-2" data-line-number="2">    get_num_waiting =<span class="st"> </span><span class="cf">function</span>()</a>
<a class="sourceLine" id="cb10-3" data-line-number="3">      <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(<span class="op">!</span>private<span class="op">$</span>tasks<span class="op">$</span>idle <span class="op">&amp;</span><span class="st"> </span>private<span class="op">$</span>tasks<span class="op">$</span>state <span class="op">==</span><span class="st"> "waiting"</span>),</a>
<a class="sourceLine" id="cb10-4" data-line-number="4">    get_num_running =<span class="st"> </span><span class="cf">function</span>() <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(private<span class="op">$</span>tasks<span class="op">$</span>state <span class="op">==</span><span class="st"> "running"</span>),</a>
<a class="sourceLine" id="cb10-5" data-line-number="5">    get_num_done =<span class="st"> </span><span class="cf">function</span>() <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(private<span class="op">$</span>tasks<span class="op">$</span>state <span class="op">==</span><span class="st"> "done"</span>),</a>
<a class="sourceLine" id="cb10-6" data-line-number="6">    is_idle =<span class="st"> </span><span class="cf">function</span>() <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(<span class="op">!</span>private<span class="op">$</span>tasks<span class="op">$</span>idle) <span class="op">==</span><span class="st"> </span><span class="dv">0</span></a></code></pre></div>
<p><code>list_tasks()</code> will just return the task data frame, for simplicity. If not all data is needed, the <code>get_num_*()</code> functions are simpler. For the first two, we need to exclude the dummy idle tasks, because they can be in the <em>waiting</em> and <em>running</em> state as well. They cannot be in the <em>done</em> state.</p>
<p>We still need to write the <code>push()</code>, <code>pop()</code> and <code><a href="http://processx.r-lib.org/reference/poll.html">poll()</a></code> public methods. As the reader might suspect, these are more involved. Let’s start with <code>push()</code>.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb11-1" data-line-number="1">    push =<span class="st"> </span><span class="cf">function</span>(fun, <span class="dt">args =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(), <span class="dt">id =</span> <span class="ot">NULL</span>) {</a>
<a class="sourceLine" id="cb11-2" data-line-number="2">      <span class="cf">if</span> (<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/NULL">is.null</a></span>(id)) id &lt;-<span class="st"> </span>private<span class="op">$</span><span class="kw">get_next_id</span>()</a>
<a class="sourceLine" id="cb11-3" data-line-number="3">      <span class="cf">if</span> (id <span class="op">%in%</span><span class="st"> </span>private<span class="op">$</span>tasks<span class="op">$</span>id) <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/stop">stop</a></span>(<span class="st">"Duplicate task id"</span>)</a>
<a class="sourceLine" id="cb11-4" data-line-number="4">      before &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/which">which</a></span>(private<span class="op">$</span>tasks<span class="op">$</span>idle)[<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb11-5" data-line-number="5">      private<span class="op">$</span>tasks &lt;-<span class="st"> </span>tibble<span class="op">::</span><span class="kw"><a href="https://tibble.tidyverse.org/reference/add_row.html">add_row</a></span>(private<span class="op">$</span>tasks, <span class="dt">.before =</span> before,</a>
<a class="sourceLine" id="cb11-6" data-line-number="6">        <span class="dt">id =</span> id, <span class="dt">idle =</span> <span class="ot">FALSE</span>, <span class="dt">state =</span> <span class="st">"waiting"</span>, <span class="dt">fun =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(fun),</a>
<a class="sourceLine" id="cb11-7" data-line-number="7">        <span class="dt">args =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(args), <span class="dt">worker =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="ot">NULL</span>), <span class="dt">result =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="ot">NULL</span>))</a>
<a class="sourceLine" id="cb11-8" data-line-number="8">      private<span class="op">$</span><span class="kw">schedule</span>()</a>
<a class="sourceLine" id="cb11-9" data-line-number="9">      <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/invisible">invisible</a></span>(id)</a>
<a class="sourceLine" id="cb11-10" data-line-number="10">    }</a></code></pre></div>
<p>The queue needs to run the tasks in the same order as they were added. The data frame will keep the correct order, with the additional tweak that the idle tasks are always at the end. Indeed, these should only run if there is no other task waiting. So <code>push()</code> adds the new task right before the idle tasks.</p>
<p>The <code>schedule()</code> private method is the core of the queue. It starts the tasks on the selected background R workers, and it also reads out the results after they are done. I.e. it performs the <em>waiting</em> to <em>running</em> and <em>ready</em> to <em>done</em> task state transitions. We will show it later.</p>
<p><code>push()</code> returns the id of the newly added task, this can be helpful to follow the task and match it to the results of a <code>pop()</code> call.</p>
<p><code>pop()</code> uses <code><a href="http://processx.r-lib.org/reference/poll.html">poll()</a></code> to get a list of tasks that are <em>done</em>, and returns the result of the oldest one, which is always the first, thanks to the ordering of the task data frame.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb12-1" data-line-number="1">    pop =<span class="st"> </span><span class="cf">function</span>(<span class="dt">timeout =</span> <span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb12-2" data-line-number="2">      <span class="cf">if</span> (<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/NA">is.na</a></span>(done &lt;-<span class="st"> </span>self<span class="op">$</span><span class="kw"><a href="http://processx.r-lib.org/reference/poll.html">poll</a></span>(timeout)[<span class="dv">1</span>])) <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(<span class="ot">NULL</span>)</a>
<a class="sourceLine" id="cb12-3" data-line-number="3">      row &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/match">match</a></span>(done, private<span class="op">$</span>tasks<span class="op">$</span>id)</a>
<a class="sourceLine" id="cb12-4" data-line-number="4">      result &lt;-<span class="st"> </span>private<span class="op">$</span>tasks<span class="op">$</span>result[[row]]</a>
<a class="sourceLine" id="cb12-5" data-line-number="5">      private<span class="op">$</span>tasks &lt;-<span class="st"> </span>private<span class="op">$</span>tasks[<span class="op">-</span>row, ]</a>
<a class="sourceLine" id="cb12-6" data-line-number="6">      <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(result, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">task_id =</span> done))</a>
<a class="sourceLine" id="cb12-7" data-line-number="7">    }</a></code></pre></div>
<p>If no task is <em>done</em>, then it returns <code>NULL</code>. The returned task is removed from the task data frame, and from the queue in general, for good. <code>pop()</code> adds the id of the task to the returned result as <code>task_id</code>, for easier matching of tasks to results.</p>
<p><code><a href="http://processx.r-lib.org/reference/poll.html">poll()</a></code> is the only method that checks on the running workers. This is important to remember, and unfortunately easy to forget. If the user does not call <code><a href="http://processx.r-lib.org/reference/poll.html">poll()</a></code>, either directly or via <code>pop()</code>, the state of a <em>running</em> task cannot change, even if the background R session itself has finished. In other words, one cannot check the status of the tasks by listing the task data frame with <code>list_tasks()</code> periodically. This will never change if <code><a href="http://processx.r-lib.org/reference/poll.html">poll()</a></code> is not called.</p>
<p>I start with an initial version of <code><a href="http://processx.r-lib.org/reference/poll.html">poll()</a></code>, which will need changes later, but this is hopefully easier to understand first:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb13-1" data-line-number="1">    poll =<span class="st"> </span><span class="cf">function</span>(<span class="dt">timeout =</span> <span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb13-2" data-line-number="2">      as_ms &lt;-<span class="st"> </span><span class="cf">function</span>(x)</a>
<a class="sourceLine" id="cb13-3" data-line-number="3">        <span class="cf">if</span> (x<span class="op">==</span><span class="ot">Inf</span>) <span class="dv">-1</span> <span class="cf">else</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/integer">as.integer</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/double">as.double</a></span>(x, <span class="st">"secs"</span>) <span class="op">*</span><span class="st"> </span><span class="dv">1000</span>)</a>
<a class="sourceLine" id="cb13-4" data-line-number="4">      topoll &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/which">which</a></span>(private<span class="op">$</span>tasks<span class="op">$</span>state <span class="op">==</span><span class="st"> "running"</span>)</a>
<a class="sourceLine" id="cb13-5" data-line-number="5">      conns &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">lapply</a></span>(</a>
<a class="sourceLine" id="cb13-6" data-line-number="6">        private<span class="op">$</span>tasks<span class="op">$</span>worker[topoll],</a>
<a class="sourceLine" id="cb13-7" data-line-number="7">        <span class="cf">function</span>(x) x<span class="op">$</span><span class="kw">get_poll_connection</span>())</a>
<a class="sourceLine" id="cb13-8" data-line-number="8">      pr &lt;-<span class="st"> </span>processx<span class="op">::</span><span class="kw"><a href="http://processx.r-lib.org/reference/poll.html">poll</a></span>(conns, <span class="kw">as_ms</span>(timeout))</a>
<a class="sourceLine" id="cb13-9" data-line-number="9">      private<span class="op">$</span>tasks<span class="op">$</span>state[topoll][pr <span class="op">==</span><span class="st"> "ready"</span>] &lt;-<span class="st"> "ready"</span></a>
<a class="sourceLine" id="cb13-10" data-line-number="10">      private<span class="op">$</span><span class="kw">schedule</span>()</a>
<a class="sourceLine" id="cb13-11" data-line-number="11">      private<span class="op">$</span>tasks<span class="op">$</span>id[private<span class="op">$</span>tasks<span class="op">$</span>state <span class="op">==</span><span class="st"> "done"</span>]</a>
<a class="sourceLine" id="cb13-12" data-line-number="12">    }</a></code></pre></div>
<p>We only need to check on tasks that are <em>running</em>. <code><a href="http://processx.r-lib.org/reference/poll.html">poll()</a></code> uses the <code><a href="http://processx.r-lib.org/reference/poll.html">processx::poll()</a></code> function that can wait on several <code><a href="../reference/r_session.html">callr::r_session</a></code>s at once. More precisely, I extract the <em>poll connections</em> of the <code>r_session</code> objects and call <code><a href="http://processx.r-lib.org/reference/poll.html">processx::poll()</a></code> on these. An <code>r_session</code> may have multiple pollable connections, one for its standard output stream, one for its standard error stream. These are not used by default in <code>r_session</code>s, and I only want to check on the poll connection, which signals if the R session has finished with the computation (or encountered an error while working on it). <code><a href="http://processx.r-lib.org/reference/poll.html">processx::poll()</a></code> returns a list of character vectors, one entry for each (<em>running</em>) task. This is <code>"ready"</code> if the session is ready with the task. (Or it is <code>"silent"</code> if it is not ready, or <code>"timeout"</code> if the time limit expired and no workers are ready.)</p>
<p>All tasks that returned <code>"ready"</code> are indeed set to the <em>ready</em> state. After this <code><a href="http://processx.r-lib.org/reference/poll.html">poll()</a></code> calls <code>schedule()</code> to read out the results of the <em>ready</em> tasks and reassign their workers to <em>waiting</em> ones.</p>
<p><code><a href="http://processx.r-lib.org/reference/poll.html">poll()</a></code> returns the ids of all tasks that are <em>done</em>.</p>
<p>This version of <code><a href="http://processx.r-lib.org/reference/poll.html">poll()</a></code> has a small issue when the R sessions are starting up: it might return without any results, before the specified timeout value is over. At startup the idle tasks are <em>running,</em> and they are polled by <code><a href="http://processx.r-lib.org/reference/poll.html">processx::poll()</a></code>. If any of the R sessions start up before the timeout is over, <code><a href="http://processx.r-lib.org/reference/poll.html">processx::poll()</a></code> returns with <code>"ready"</code> for them. But <code>schedule()</code> cannot mark these tasks as <em>done</em>, because they are idle tasks, they’ll be <em>waiting</em>, and with no task <em>done</em>, <code><a href="http://processx.r-lib.org/reference/poll.html">poll()</a></code> will return an empty vector. This is problematic, because <code><a href="http://processx.r-lib.org/reference/poll.html">poll()</a></code> promises to either wait until the specified timeout <em>or</em> return a task that is <em>done</em>. So we need to wrap the simplified <code><a href="http://processx.r-lib.org/reference/poll.html">poll()</a></code> into a loop, and keep calling <code><a href="http://processx.r-lib.org/reference/poll.html">processx::poll()</a></code> until either the timeout expires or a task is <em>done</em>. The final <code><a href="http://processx.r-lib.org/reference/poll.html">poll()</a></code> looks like this:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb14-1" data-line-number="1">    poll =<span class="st"> </span><span class="cf">function</span>(<span class="dt">timeout =</span> <span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb14-2" data-line-number="2">      limit &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.time</a></span>() <span class="op">+</span><span class="st"> </span>timeout</a>
<a class="sourceLine" id="cb14-3" data-line-number="3">      as_ms &lt;-<span class="st"> </span><span class="cf">function</span>(x)</a>
<a class="sourceLine" id="cb14-4" data-line-number="4">        <span class="cf">if</span> (x<span class="op">==</span><span class="ot">Inf</span>) <span class="dv">-1</span> <span class="cf">else</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/integer">as.integer</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/double">as.double</a></span>(x, <span class="st">"secs"</span>) <span class="op">*</span><span class="st"> </span><span class="dv">1000</span>)</a>
<a class="sourceLine" id="cb14-5" data-line-number="5">      <span class="cf">repeat</span>{</a>
<a class="sourceLine" id="cb14-6" data-line-number="6">        topoll &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/which">which</a></span>(private<span class="op">$</span>tasks<span class="op">$</span>state <span class="op">==</span><span class="st"> "running"</span>)</a>
<a class="sourceLine" id="cb14-7" data-line-number="7">        conns &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">lapply</a></span>(</a>
<a class="sourceLine" id="cb14-8" data-line-number="8">          private<span class="op">$</span>tasks<span class="op">$</span>worker[topoll],</a>
<a class="sourceLine" id="cb14-9" data-line-number="9">          <span class="cf">function</span>(x) x<span class="op">$</span><span class="kw">get_poll_connection</span>())</a>
<a class="sourceLine" id="cb14-10" data-line-number="10">        pr &lt;-<span class="st"> </span>processx<span class="op">::</span><span class="kw"><a href="http://processx.r-lib.org/reference/poll.html">poll</a></span>(conns, <span class="kw">as_ms</span>(timeout))</a>
<a class="sourceLine" id="cb14-11" data-line-number="11">        private<span class="op">$</span>tasks<span class="op">$</span>state[topoll][pr <span class="op">==</span><span class="st"> "ready"</span>] &lt;-<span class="st"> "ready"</span></a>
<a class="sourceLine" id="cb14-12" data-line-number="12">        private<span class="op">$</span><span class="kw">schedule</span>()</a>
<a class="sourceLine" id="cb14-13" data-line-number="13">        ret &lt;-<span class="st"> </span>private<span class="op">$</span>tasks<span class="op">$</span>id[private<span class="op">$</span>tasks<span class="op">$</span>state <span class="op">==</span><span class="st"> "done"</span>]</a>
<a class="sourceLine" id="cb14-14" data-line-number="14">        <span class="cf">if</span> (<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/is.finite">is.finite</a></span>(timeout)) timeout &lt;-<span class="st"> </span>limit <span class="op">-</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.time</a></span>()</a>
<a class="sourceLine" id="cb14-15" data-line-number="15">        <span class="cf">if</span> (<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(ret) <span class="op">||</span><span class="st"> </span>timeout <span class="op">&lt;</span><span class="st"> </span><span class="dv">0</span>) <span class="cf">break</span>;</a>
<a class="sourceLine" id="cb14-16" data-line-number="16">      }</a>
<a class="sourceLine" id="cb14-17" data-line-number="17">      ret</a>
<a class="sourceLine" id="cb14-18" data-line-number="18">    }</a></code></pre></div>
<p>Unfortunately <code><a href="http://processx.r-lib.org/reference/poll.html">processx::poll()</a></code> expects the timeout as an integer in milliseconds, not as a <code>difftime</code> object, hence the somewhat tedious time unit conversions.</p>
<p>Only the private <code>schedule()</code> method is missing now:</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb15-1" data-line-number="1">    schedule =<span class="st"> </span><span class="cf">function</span>() {</a>
<a class="sourceLine" id="cb15-2" data-line-number="2">      ready &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/which">which</a></span>(private<span class="op">$</span>tasks<span class="op">$</span>state <span class="op">==</span><span class="st"> "ready"</span>)</a>
<a class="sourceLine" id="cb15-3" data-line-number="3">      <span class="cf">if</span> (<span class="op">!</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(ready)) <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>()</a>
<a class="sourceLine" id="cb15-4" data-line-number="4">      rss &lt;-<span class="st"> </span>private<span class="op">$</span>tasks<span class="op">$</span>worker[ready]</a>
<a class="sourceLine" id="cb15-5" data-line-number="5"></a>
<a class="sourceLine" id="cb15-6" data-line-number="6">      private<span class="op">$</span>tasks<span class="op">$</span>result[ready] &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">lapply</a></span>(rss, <span class="cf">function</span>(x) x<span class="op">$</span><span class="kw">read</span>())</a>
<a class="sourceLine" id="cb15-7" data-line-number="7">      private<span class="op">$</span>tasks<span class="op">$</span>worker[ready] &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">replicate</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(ready), <span class="ot">NULL</span>)</a>
<a class="sourceLine" id="cb15-8" data-line-number="8">      private<span class="op">$</span>tasks<span class="op">$</span>state[ready] &lt;-</a>
<a class="sourceLine" id="cb15-9" data-line-number="9"><span class="st">        </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/ifelse">ifelse</a></span>(private<span class="op">$</span>tasks<span class="op">$</span>idle[ready], <span class="st">"waiting"</span>, <span class="st">"done"</span>)</a>
<a class="sourceLine" id="cb15-10" data-line-number="10"></a>
<a class="sourceLine" id="cb15-11" data-line-number="11">      waiting &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/which">which</a></span>(private<span class="op">$</span>tasks<span class="op">$</span>state <span class="op">==</span><span class="st"> "waiting"</span>)[<span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(ready)]</a>
<a class="sourceLine" id="cb15-12" data-line-number="12">      private<span class="op">$</span>tasks<span class="op">$</span>worker[waiting] &lt;-<span class="st"> </span>rss</a>
<a class="sourceLine" id="cb15-13" data-line-number="13">      private<span class="op">$</span>tasks<span class="op">$</span>state[waiting] &lt;-</a>
<a class="sourceLine" id="cb15-14" data-line-number="14"><span class="st">        </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/ifelse">ifelse</a></span>(private<span class="op">$</span>tasks<span class="op">$</span>idle[waiting], <span class="st">"ready"</span>, <span class="st">"running"</span>)</a>
<a class="sourceLine" id="cb15-15" data-line-number="15">      <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">lapply</a></span>(waiting, <span class="cf">function</span>(i) {</a>
<a class="sourceLine" id="cb15-16" data-line-number="16">        <span class="cf">if</span> (<span class="op">!</span><span class="st"> </span>private<span class="op">$</span>tasks<span class="op">$</span>idle[i]) {</a>
<a class="sourceLine" id="cb15-17" data-line-number="17">          private<span class="op">$</span>tasks<span class="op">$</span>worker[[i]]<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/call">call</a></span>(private<span class="op">$</span>tasks<span class="op">$</span>fun[[i]],</a>
<a class="sourceLine" id="cb15-18" data-line-number="18">                                         private<span class="op">$</span>tasks<span class="op">$</span>args[[i]])</a>
<a class="sourceLine" id="cb15-19" data-line-number="19">        }</a>
<a class="sourceLine" id="cb15-20" data-line-number="20">      })</a>
<a class="sourceLine" id="cb15-21" data-line-number="21">    }</a></code></pre></div>
<p><code>schedule()</code>’s job is to perform the <em>ready</em> to <em>done</em>` and the <em>waiting</em> to <em>running</em> state transitions. The first involves reading out the results of the <em>ready</em> tasks and the second involves starting new computation on the workers.</p>
<p>For every <em>ready</em> task, <code>schedule()</code> perform three steps:</p>
<ol style="list-style-type: decimal">
<li>Reads out and stores its result. (It can do this for the idle tasks as well, for these <code>r_session$read()</code> will return <code>NULL</code>.)</li>
<li>Removes its worker, i.e. sets it to <code>NULL</code>.</li>
<li>Updates its state to <em>done</em>. (Or to <em>waiting</em> if it is an idle task.)</li>
</ol>
<p>Then it deals with the <em>waiting</em> tasks, but not more than the number of <em>ready</em> tasks the queue had. For these <em>waiting</em> tasks <code>schedule()</code> performs three steps:</p>
<ol style="list-style-type: decimal">
<li>Assigns a just removed worker to it.</li>
<li>Sets state to <em>running</em>. (Or to <em>ready</em> for idle tasks.)</li>
<li>Calls <code>fun(args)</code> in the background session.</li>
</ol>
<p>When selecting the waiting tasks to run, the ordering of the task table makes sure that the oldest task is selected first, and that idle tasks are only selected if there is nothing else to run. The idle tasks make sure that <code>schedule()</code> always has at least as many waiting tasks as ready.</p>
<p>It is possible that <code>schedule()</code> first sets an idle task to <em>waiting</em> and then selects it and (re-)assigns a worker to it. This is perfectly fine.</p>
</div>
<div id="try-it-out" class="section level2">
<h2 class="hasAnchor">
<a href="#try-it-out" class="anchor"></a>Try it out</h2>
<p>As a simple example, we add a bunch of fake tasks to a queue, and then run a simple event loop to run it to completion. (To run this code, first you need to run the complete code at the enc of the post.)</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb16-1" data-line-number="1">q &lt;-<span class="st"> </span>task_q<span class="op">$</span><span class="kw">new</span>()</a>
<a class="sourceLine" id="cb16-2" data-line-number="2"><span class="cf">for</span> (i <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>) {</a>
<a class="sourceLine" id="cb16-3" data-line-number="3">  q<span class="op">$</span><span class="kw">push</span>(<span class="cf">function</span>(i) { <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.sleep">Sys.sleep</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/stats/topics/Uniform">runif</a></span>(<span class="dv">1</span>)); <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste</a></span>(i, <span class="st">"done"</span>) }, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">i =</span> i))</a>
<a class="sourceLine" id="cb16-4" data-line-number="4">}</a></code></pre></div>
<p>This is how the queue looks after adding all these tasks:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb17-1" data-line-number="1">q<span class="op">$</span><span class="kw">list_tasks</span>()</a>
<a class="sourceLine" id="cb17-2" data-line-number="2"><span class="co">#&gt; # A tibble: 14 x 7</span></a>
<a class="sourceLine" id="cb17-3" data-line-number="3"><span class="co">#&gt;    id      idle  state   fun    args       worker     result</span></a>
<a class="sourceLine" id="cb17-4" data-line-number="4"><span class="co">#&gt;    &lt;chr&gt;   &lt;lgl&gt; &lt;chr&gt;   &lt;list&gt; &lt;list&gt;     &lt;list&gt;     &lt;list&gt;</span></a>
<a class="sourceLine" id="cb17-5" data-line-number="5"><span class="co">#&gt;  1 .1      FALSE waiting &lt;fn&gt;   &lt;list [1]&gt; &lt;NULL&gt;     &lt;NULL&gt;</span></a>
<a class="sourceLine" id="cb17-6" data-line-number="6"><span class="co">#&gt;  2 .2      FALSE waiting &lt;fn&gt;   &lt;list [1]&gt; &lt;NULL&gt;     &lt;NULL&gt;</span></a>
<a class="sourceLine" id="cb17-7" data-line-number="7"><span class="co">#&gt;  3 .3      FALSE waiting &lt;fn&gt;   &lt;list [1]&gt; &lt;NULL&gt;     &lt;NULL&gt;</span></a>
<a class="sourceLine" id="cb17-8" data-line-number="8"><span class="co">#&gt;  4 .4      FALSE waiting &lt;fn&gt;   &lt;list [1]&gt; &lt;NULL&gt;     &lt;NULL&gt;</span></a>
<a class="sourceLine" id="cb17-9" data-line-number="9"><span class="co">#&gt;  5 .5      FALSE waiting &lt;fn&gt;   &lt;list [1]&gt; &lt;NULL&gt;     &lt;NULL&gt;</span></a>
<a class="sourceLine" id="cb17-10" data-line-number="10"><span class="co">#&gt;  6 .6      FALSE waiting &lt;fn&gt;   &lt;list [1]&gt; &lt;NULL&gt;     &lt;NULL&gt;</span></a>
<a class="sourceLine" id="cb17-11" data-line-number="11"><span class="co">#&gt;  7 .7      FALSE waiting &lt;fn&gt;   &lt;list [1]&gt; &lt;NULL&gt;     &lt;NULL&gt;</span></a>
<a class="sourceLine" id="cb17-12" data-line-number="12"><span class="co">#&gt;  8 .8      FALSE waiting &lt;fn&gt;   &lt;list [1]&gt; &lt;NULL&gt;     &lt;NULL&gt;</span></a>
<a class="sourceLine" id="cb17-13" data-line-number="13"><span class="co">#&gt;  9 .9      FALSE waiting &lt;fn&gt;   &lt;list [1]&gt; &lt;NULL&gt;     &lt;NULL&gt;</span></a>
<a class="sourceLine" id="cb17-14" data-line-number="14"><span class="co">#&gt; 10 .10     FALSE waiting &lt;fn&gt;   &lt;list [1]&gt; &lt;NULL&gt;     &lt;NULL&gt;</span></a>
<a class="sourceLine" id="cb17-15" data-line-number="15"><span class="co">#&gt; 11 .idle-1 TRUE  running &lt;NULL&gt; &lt;NULL&gt;     &lt;r_sessin&gt; &lt;NULL&gt;</span></a>
<a class="sourceLine" id="cb17-16" data-line-number="16"><span class="co">#&gt; 12 .idle-2 TRUE  running &lt;NULL&gt; &lt;NULL&gt;     &lt;r_sessin&gt; &lt;NULL&gt;</span></a>
<a class="sourceLine" id="cb17-17" data-line-number="17"><span class="co">#&gt; 13 .idle-3 TRUE  running &lt;NULL&gt; &lt;NULL&gt;     &lt;r_sessin&gt; &lt;NULL&gt;</span></a>
<a class="sourceLine" id="cb17-18" data-line-number="18"><span class="co">#&gt; 14 .idle-4 TRUE  running &lt;NULL&gt; &lt;NULL&gt;     &lt;r_sessin&gt; &lt;NULL&gt;</span></a></code></pre></div>
<p>Probably no tasks are running just yet. The queue only has the chance to change its state when you <code>push()</code>, <code>pop()</code> or <code><a href="http://processx.r-lib.org/reference/poll.html">poll()</a></code>. When pushing the tasks to the queue, the workers were still starting up (i.e. the idle tasks <em>running</em>), so <code>push()</code> could not start any real tasks. Never mind, as soon as you try to <code>pop()</code> or <code><a href="http://processx.r-lib.org/reference/poll.html">poll()</a></code>, they’ll start running:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb18-1" data-line-number="1">q<span class="op">$</span><span class="kw"><a href="http://processx.r-lib.org/reference/poll.html">poll</a></span>(sec)</a>
<a class="sourceLine" id="cb18-2" data-line-number="2"><span class="co">#&gt; [1] ".3"</span></a>
<a class="sourceLine" id="cb18-3" data-line-number="3">q<span class="op">$</span><span class="kw">list_tasks</span>()</a>
<a class="sourceLine" id="cb18-4" data-line-number="4"><span class="co">#&gt; # A tibble: 14 x 7</span></a>
<a class="sourceLine" id="cb18-5" data-line-number="5"><span class="co">#&gt;    id      idle  state   fun    args       worker     result    </span></a>
<a class="sourceLine" id="cb18-6" data-line-number="6"><span class="co">#&gt;    &lt;chr&gt;   &lt;lgl&gt; &lt;chr&gt;   &lt;list&gt; &lt;list&gt;     &lt;list&gt;     &lt;list&gt;    </span></a>
<a class="sourceLine" id="cb18-7" data-line-number="7"><span class="co">#&gt;  1 .1      FALSE running &lt;fn&gt;   &lt;list [1]&gt; &lt;r_sessin&gt; &lt;NULL&gt;    </span></a>
<a class="sourceLine" id="cb18-8" data-line-number="8"><span class="co">#&gt;  2 .2      FALSE running &lt;fn&gt;   &lt;list [1]&gt; &lt;r_sessin&gt; &lt;NULL&gt;    </span></a>
<a class="sourceLine" id="cb18-9" data-line-number="9"><span class="co">#&gt;  3 .3      FALSE done    &lt;fn&gt;   &lt;list [1]&gt; &lt;NULL&gt;     &lt;cllr_ss_&gt;</span></a>
<a class="sourceLine" id="cb18-10" data-line-number="10"><span class="co">#&gt;  4 .4      FALSE running &lt;fn&gt;   &lt;list [1]&gt; &lt;r_sessin&gt; &lt;NULL&gt;    </span></a>
<a class="sourceLine" id="cb18-11" data-line-number="11"><span class="co">#&gt;  5 .5      FALSE running &lt;fn&gt;   &lt;list [1]&gt; &lt;r_sessin&gt; &lt;NULL&gt;    </span></a>
<a class="sourceLine" id="cb18-12" data-line-number="12"><span class="co">#&gt;  6 .6      FALSE waiting &lt;fn&gt;   &lt;list [1]&gt; &lt;NULL&gt;     &lt;NULL&gt;    </span></a>
<a class="sourceLine" id="cb18-13" data-line-number="13"><span class="co">#&gt;  7 .7      FALSE waiting &lt;fn&gt;   &lt;list [1]&gt; &lt;NULL&gt;     &lt;NULL&gt;    </span></a>
<a class="sourceLine" id="cb18-14" data-line-number="14"><span class="co">#&gt;  8 .8      FALSE waiting &lt;fn&gt;   &lt;list [1]&gt; &lt;NULL&gt;     &lt;NULL&gt;    </span></a>
<a class="sourceLine" id="cb18-15" data-line-number="15"><span class="co">#&gt;  9 .9      FALSE waiting &lt;fn&gt;   &lt;list [1]&gt; &lt;NULL&gt;     &lt;NULL&gt;    </span></a>
<a class="sourceLine" id="cb18-16" data-line-number="16"><span class="co">#&gt; 10 .10     FALSE waiting &lt;fn&gt;   &lt;list [1]&gt; &lt;NULL&gt;     &lt;NULL&gt;    </span></a>
<a class="sourceLine" id="cb18-17" data-line-number="17"><span class="co">#&gt; 11 .idle-1 TRUE  waiting &lt;NULL&gt; &lt;NULL&gt;     &lt;NULL&gt;     &lt;cllr_ss_&gt;</span></a>
<a class="sourceLine" id="cb18-18" data-line-number="18"><span class="co">#&gt; 12 .idle-2 TRUE  waiting &lt;NULL&gt; &lt;NULL&gt;     &lt;NULL&gt;     &lt;cllr_ss_&gt;</span></a>
<a class="sourceLine" id="cb18-19" data-line-number="19"><span class="co">#&gt; 13 .idle-3 TRUE  waiting &lt;NULL&gt; &lt;NULL&gt;     &lt;NULL&gt;     &lt;cllr_ss_&gt;</span></a>
<a class="sourceLine" id="cb18-20" data-line-number="20"><span class="co">#&gt; 14 .idle-4 TRUE  waiting &lt;NULL&gt; &lt;NULL&gt;     &lt;NULL&gt;     &lt;cllr_ss_&gt;</span></a></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb19-1" data-line-number="1"><span class="cf">while</span> (<span class="op">!</span>q<span class="op">$</span><span class="kw">is_idle</span>()) {</a>
<a class="sourceLine" id="cb19-2" data-line-number="2">  task_result &lt;-<span class="st"> </span>q<span class="op">$</span><span class="kw">pop</span>(<span class="ot">Inf</span>)</a>
<a class="sourceLine" id="cb19-3" data-line-number="3">  <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/print">print</a></span>(task_result<span class="op">$</span>result)</a>
<a class="sourceLine" id="cb19-4" data-line-number="4">}</a>
<a class="sourceLine" id="cb19-5" data-line-number="5"><span class="co">#&gt; [1] "3 done"</span></a>
<a class="sourceLine" id="cb19-6" data-line-number="6"><span class="co">#&gt; [1] "2 done"</span></a>
<a class="sourceLine" id="cb19-7" data-line-number="7"><span class="co">#&gt; [1] "4 done"</span></a>
<a class="sourceLine" id="cb19-8" data-line-number="8"><span class="co">#&gt; [1] "1 done"</span></a>
<a class="sourceLine" id="cb19-9" data-line-number="9"><span class="co">#&gt; [1] "5 done"</span></a>
<a class="sourceLine" id="cb19-10" data-line-number="10"><span class="co">#&gt; [1] "7 done"</span></a>
<a class="sourceLine" id="cb19-11" data-line-number="11"><span class="co">#&gt; [1] "6 done"</span></a>
<a class="sourceLine" id="cb19-12" data-line-number="12"><span class="co">#&gt; [1] "8 done"</span></a>
<a class="sourceLine" id="cb19-13" data-line-number="13"><span class="co">#&gt; [1] "9 done"</span></a>
<a class="sourceLine" id="cb19-14" data-line-number="14"><span class="co">#&gt; [1] "10 done"</span></a></code></pre></div>
<p><code>pop()</code> just returns whatever <code>r_session$read()</code> returns. Here is the last result from the loop:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb20-1" data-line-number="1">task_result</a>
<a class="sourceLine" id="cb20-2" data-line-number="2"><span class="co">#&gt; $code</span></a>
<a class="sourceLine" id="cb20-3" data-line-number="3"><span class="co">#&gt; [1] 200</span></a>
<a class="sourceLine" id="cb20-4" data-line-number="4"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb20-5" data-line-number="5"><span class="co">#&gt; $message</span></a>
<a class="sourceLine" id="cb20-6" data-line-number="6"><span class="co">#&gt; [1] "done file3d760888876"</span></a>
<a class="sourceLine" id="cb20-7" data-line-number="7"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb20-8" data-line-number="8"><span class="co">#&gt; $result</span></a>
<a class="sourceLine" id="cb20-9" data-line-number="9"><span class="co">#&gt; [1] "10 done"</span></a>
<a class="sourceLine" id="cb20-10" data-line-number="10"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb20-11" data-line-number="11"><span class="co">#&gt; $stdout</span></a>
<a class="sourceLine" id="cb20-12" data-line-number="12"><span class="co">#&gt; [1] ""</span></a>
<a class="sourceLine" id="cb20-13" data-line-number="13"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb20-14" data-line-number="14"><span class="co">#&gt; $stderr</span></a>
<a class="sourceLine" id="cb20-15" data-line-number="15"><span class="co">#&gt; [1] ""</span></a>
<a class="sourceLine" id="cb20-16" data-line-number="16"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb20-17" data-line-number="17"><span class="co">#&gt; $error</span></a>
<a class="sourceLine" id="cb20-18" data-line-number="18"><span class="co">#&gt; NULL</span></a>
<a class="sourceLine" id="cb20-19" data-line-number="19"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb20-20" data-line-number="20"><span class="co">#&gt; $task_id</span></a>
<a class="sourceLine" id="cb20-21" data-line-number="21"><span class="co">#&gt; [1] ".10"</span></a></code></pre></div>
<p>The important fields are:</p>
<ul>
<li>
<code>result</code>: the R object returned from the function. This is <code>NULL</code> on error.</li>
<li>
<code>stdout</code>: the standard output of the background session, while running the function.</li>
<li>
<code>stderr</code>: the standard error.</li>
<li>
<code>error</code>: error object if the function failed. <code>NULL</code> otherwise.</li>
<li>
<code>task_id</code>: the user supplied or auto-generated task id.</li>
</ul>
<p>Let’s see a task that errors.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb21-1" data-line-number="1">q<span class="op">$</span><span class="kw">push</span>(<span class="cf">function</span>() <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/stop">stop</a></span>(<span class="st">"This failed, sorry"</span>))</a>
<a class="sourceLine" id="cb21-2" data-line-number="2">res &lt;-<span class="st"> </span>q<span class="op">$</span><span class="kw">pop</span>(<span class="ot">Inf</span>)</a>
<a class="sourceLine" id="cb21-3" data-line-number="3">res<span class="op">$</span>error</a>
<a class="sourceLine" id="cb21-4" data-line-number="4"><span class="co">#&gt; &lt;callr_status_error: callr subprocess failed: This failed, sorry&gt;</span></a>
<a class="sourceLine" id="cb21-5" data-line-number="5"><span class="co">#&gt;  in process </span></a>
<a class="sourceLine" id="cb21-6" data-line-number="6"><span class="co">#&gt; --&gt;</span></a>
<a class="sourceLine" id="cb21-7" data-line-number="7"><span class="co">#&gt; &lt;callr_remote_error in (function () stop("This failed, sorry"))(): This failed, sorry&gt;</span></a></code></pre></div>
<p>The error is two-part, the first refers to the main process, and the second is the original error, thrown in the background process. To help with debugging, the error from the background process includes a stack trace:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb22-1" data-line-number="1">res<span class="op">$</span>error<span class="op">$</span>parent<span class="op">$</span>trace</a>
<a class="sourceLine" id="cb22-2" data-line-number="2"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb22-3" data-line-number="3"><span class="co">#&gt;  ERROR TRACE for simpleError</span></a>
<a class="sourceLine" id="cb22-4" data-line-number="4"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb22-5" data-line-number="5"><span class="co">#&gt;  12. (function ()  ...</span></a>
<a class="sourceLine" id="cb22-6" data-line-number="6"><span class="co">#&gt;  13. base:::stop("This failed, sorry")</span></a>
<a class="sourceLine" id="cb22-7" data-line-number="7"><span class="co">#&gt;     R/&lt;text&gt;:1:8</span></a>
<a class="sourceLine" id="cb22-8" data-line-number="8"><span class="co">#&gt;  14. base:::.handleSimpleError(function (e)  ...</span></a>
<a class="sourceLine" id="cb22-9" data-line-number="9"><span class="co">#&gt;  15. h(simpleError(msg, call))</span></a>
<a class="sourceLine" id="cb22-10" data-line-number="10"><span class="co">#&gt; </span></a>
<a class="sourceLine" id="cb22-11" data-line-number="11"><span class="co">#&gt;  x This failed, sorry</span></a></code></pre></div>
<p>For this simple function that just calls <code><a href="https://www.rdocumentation.org/packages/base/topics/stop">stop()</a></code> the trace is not very exciting, but it can be very helpful in general.</p>
</div>
<div id="how-about-process-cleanup" class="section level2">
<h2 class="hasAnchor">
<a href="#how-about-process-cleanup" class="anchor"></a>How about process cleanup?</h2>
<p>Luckily we don’t have to do anything extra to clean up the R processes. <code><a href="../reference/r_session.html">callr::r_session</a></code> objects kill their background R session in their finalizer, i.e. when they are garbage collected. As soon as the workers have no references, because e.g. the queue object itself has no references, the garbage collector will clean them up. An explicit <code>kill()</code> method would be still useful sometimes, but we leave that as an exercise to the reader.</p>
</div>
<div id="possible-improvements" class="section level2">
<h2 class="hasAnchor">
<a href="#possible-improvements" class="anchor"></a>Possible improvements</h2>
<p>To use this task queue in real code, you would need to make it a bit more robust and flexible.</p>
<ol style="list-style-type: decimal">
<li>Most importantly, you would need to handle crashes and freezes in the worker tasks. <code><a href="../reference/r_session.html">callr::r_session</a></code> does handle crashes properly, i.e. <code><a href="http://processx.r-lib.org/reference/poll.html">poll()</a></code> returns immediately if the session crashes, and then <code>read()</code> returns an informative error result. But the task queue should also do something sensible in this case, e.g. return the error result, and restart the worker.</li>
<li>To handle freezing worker tasks, the queue could support task timeouts, and then kill the tasks that don’t finish before their timeout expires. This can be probably implemented using the <code>r_session$interrupt()</code> and <code>r_session$kill()</code> methods.</li>
<li>Make the queue interrupt-safe. All operations of the queue (e.g. <code><a href="http://processx.r-lib.org/reference/poll.html">poll()</a></code>, <code>pop()</code>, etc.) are interruptible by the user, but they don’t always leave the task data frame and the background sessions in a consistent state. E.g. if <code>schedule()</code> is interrupted, if you are unlucky you might lose all worker processes. This is a very hard issue to solve, the relatively new <code><a href="https://www.rdocumentation.org/packages/base/topics/conditions">suspendInterrupts()</a></code> function probably helps a lot.</li>
<li>It would be great to be able to change the <code>concurrency</code> level of the queue dynamically, i.e. add and remove worker processes.</li>
<li>The whole queue could be implemented in a background process, so that the scheduler runs concurrently with the main R process. This is far from being trivial, especially if one wants to avoid copying data (the function arguments) twice for every task.</li>
</ol>
</div>
<div id="summary" class="section level2">
<h2 class="hasAnchor">
<a href="#summary" class="anchor"></a>Summary</h2>
</div>
<div id="complete-code" class="section level2">
<h2 class="hasAnchor">
<a href="#complete-code" class="anchor"></a>Complete code</h2>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb23-1" data-line-number="1">task_q &lt;-<span class="st"> </span>R6<span class="op">::</span><span class="kw"><a href="https://www.rdocumentation.org/packages/R6/topics/R6Class">R6Class</a></span>(</a>
<a class="sourceLine" id="cb23-2" data-line-number="2">  <span class="st">"task_q"</span>,</a>
<a class="sourceLine" id="cb23-3" data-line-number="3">  <span class="dt">public =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(</a>
<a class="sourceLine" id="cb23-4" data-line-number="4">    <span class="dt">initialize =</span> <span class="cf">function</span>(<span class="dt">concurrency =</span> 4L) {</a>
<a class="sourceLine" id="cb23-5" data-line-number="5">      private<span class="op">$</span><span class="kw">start_workers</span>(concurrency)</a>
<a class="sourceLine" id="cb23-6" data-line-number="6">      <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/invisible">invisible</a></span>(self)</a>
<a class="sourceLine" id="cb23-7" data-line-number="7">    },</a>
<a class="sourceLine" id="cb23-8" data-line-number="8">    <span class="dt">list_tasks =</span> <span class="cf">function</span>() private<span class="op">$</span>tasks,</a>
<a class="sourceLine" id="cb23-9" data-line-number="9">    <span class="dt">get_num_waiting =</span> <span class="cf">function</span>()</a>
<a class="sourceLine" id="cb23-10" data-line-number="10">      <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(<span class="op">!</span>private<span class="op">$</span>tasks<span class="op">$</span>idle <span class="op">&amp;</span><span class="st"> </span>private<span class="op">$</span>tasks<span class="op">$</span>state <span class="op">==</span><span class="st"> "waiting"</span>),</a>
<a class="sourceLine" id="cb23-11" data-line-number="11">    <span class="dt">get_num_running =</span> <span class="cf">function</span>()</a>
<a class="sourceLine" id="cb23-12" data-line-number="12">      <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(<span class="op">!</span>private<span class="op">$</span>tasks<span class="op">$</span>idle <span class="op">&amp;</span><span class="st"> </span>private<span class="op">$</span>tasks<span class="op">$</span>state <span class="op">==</span><span class="st"> "running"</span>),</a>
<a class="sourceLine" id="cb23-13" data-line-number="13">    <span class="dt">get_num_done =</span> <span class="cf">function</span>() <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/sum">sum</a></span>(private<span class="op">$</span>tasks<span class="op">$</span>state <span class="op">==</span><span class="st"> "done"</span>),</a>
<a class="sourceLine" id="cb23-14" data-line-number="14"></a>
<a class="sourceLine" id="cb23-15" data-line-number="15">    <span class="dt">push =</span> <span class="cf">function</span>(fun, <span class="dt">args =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(), <span class="dt">id =</span> <span class="ot">NULL</span>) {</a>
<a class="sourceLine" id="cb23-16" data-line-number="16">      <span class="cf">if</span> (<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/NULL">is.null</a></span>(id)) id &lt;-<span class="st"> </span>private<span class="op">$</span><span class="kw">get_next_id</span>()</a>
<a class="sourceLine" id="cb23-17" data-line-number="17">      <span class="cf">if</span> (id <span class="op">%in%</span><span class="st"> </span>private<span class="op">$</span>tasks<span class="op">$</span>id) <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/stop">stop</a></span>(<span class="st">"Duplicate task id"</span>)</a>
<a class="sourceLine" id="cb23-18" data-line-number="18">      before &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/which">which</a></span>(private<span class="op">$</span>tasks<span class="op">$</span>idle)[<span class="dv">1</span>]</a>
<a class="sourceLine" id="cb23-19" data-line-number="19">      private<span class="op">$</span>tasks &lt;-<span class="st"> </span>tibble<span class="op">::</span><span class="kw"><a href="https://tibble.tidyverse.org/reference/add_row.html">add_row</a></span>(private<span class="op">$</span>tasks, <span class="dt">.before =</span> before,</a>
<a class="sourceLine" id="cb23-20" data-line-number="20">        <span class="dt">id =</span> id, <span class="dt">idle =</span> <span class="ot">FALSE</span>, <span class="dt">state =</span> <span class="st">"waiting"</span>, <span class="dt">fun =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(fun),</a>
<a class="sourceLine" id="cb23-21" data-line-number="21">        <span class="dt">args =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(args), <span class="dt">worker =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="ot">NULL</span>), <span class="dt">result =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="ot">NULL</span>))</a>
<a class="sourceLine" id="cb23-22" data-line-number="22">      private<span class="op">$</span><span class="kw">schedule</span>()</a>
<a class="sourceLine" id="cb23-23" data-line-number="23">      <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/invisible">invisible</a></span>(id)</a>
<a class="sourceLine" id="cb23-24" data-line-number="24">    },</a>
<a class="sourceLine" id="cb23-25" data-line-number="25"></a>
<a class="sourceLine" id="cb23-26" data-line-number="26">    <span class="dt">poll =</span> <span class="cf">function</span>(<span class="dt">timeout =</span> <span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb23-27" data-line-number="27">      limit &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.time</a></span>() <span class="op">+</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/difftime">as.difftime</a></span>(timeout <span class="op">/</span><span class="st"> </span><span class="dv">1000</span>, <span class="dt">units =</span> <span class="st">"secs"</span>)</a>
<a class="sourceLine" id="cb23-28" data-line-number="28">      <span class="cf">repeat</span>{</a>
<a class="sourceLine" id="cb23-29" data-line-number="29">        topoll &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/which">which</a></span>(private<span class="op">$</span>tasks<span class="op">$</span>state <span class="op">==</span><span class="st"> "running"</span>)</a>
<a class="sourceLine" id="cb23-30" data-line-number="30">        conns &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">lapply</a></span>(</a>
<a class="sourceLine" id="cb23-31" data-line-number="31">          private<span class="op">$</span>tasks<span class="op">$</span>worker[topoll],</a>
<a class="sourceLine" id="cb23-32" data-line-number="32">          <span class="cf">function</span>(x) x<span class="op">$</span><span class="kw">get_poll_connection</span>())</a>
<a class="sourceLine" id="cb23-33" data-line-number="33">        pr &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/unlist">unlist</a></span>(processx<span class="op">::</span><span class="kw"><a href="http://processx.r-lib.org/reference/poll.html">poll</a></span>(conns, timeout))</a>
<a class="sourceLine" id="cb23-34" data-line-number="34">        private<span class="op">$</span>tasks<span class="op">$</span>state[topoll][pr <span class="op">==</span><span class="st"> "ready"</span>] &lt;-<span class="st"> "ready"</span></a>
<a class="sourceLine" id="cb23-35" data-line-number="35">        private<span class="op">$</span><span class="kw">schedule</span>()</a>
<a class="sourceLine" id="cb23-36" data-line-number="36">        ret &lt;-<span class="st"> </span>private<span class="op">$</span>tasks<span class="op">$</span>id[private<span class="op">$</span>tasks<span class="op">$</span>state <span class="op">==</span><span class="st"> "done"</span>]</a>
<a class="sourceLine" id="cb23-37" data-line-number="37">        <span class="cf">if</span> (<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(ret) <span class="op">||</span><span class="st"> </span>(timeout <span class="op">!=</span><span class="st"> </span><span class="dv">-1</span> <span class="op">&amp;&amp;</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.time</a></span>() <span class="op">&gt;</span><span class="st"> </span>limit)) <span class="cf">break</span>;</a>
<a class="sourceLine" id="cb23-38" data-line-number="38">        <span class="cf">if</span> (timeout <span class="op">!=</span><span class="st"> </span><span class="dv">-1</span>)</a>
<a class="sourceLine" id="cb23-39" data-line-number="39">          timeout &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Extremes">max</a></span>(<span class="dv">0</span>, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/double">as.double</a></span>(limit <span class="op">-</span><span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/Sys.time">Sys.time</a></span>(), <span class="dt">units =</span> <span class="st">"secs"</span>))</a>
<a class="sourceLine" id="cb23-40" data-line-number="40">      }</a>
<a class="sourceLine" id="cb23-41" data-line-number="41">      ret</a>
<a class="sourceLine" id="cb23-42" data-line-number="42">    },</a>
<a class="sourceLine" id="cb23-43" data-line-number="43"></a>
<a class="sourceLine" id="cb23-44" data-line-number="44">    <span class="dt">pop =</span> <span class="cf">function</span>(<span class="dt">timeout =</span> <span class="dv">0</span>) {</a>
<a class="sourceLine" id="cb23-45" data-line-number="45">      <span class="cf">if</span> (<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/NA">is.na</a></span>(done &lt;-<span class="st"> </span>self<span class="op">$</span><span class="kw"><a href="http://processx.r-lib.org/reference/poll.html">poll</a></span>(timeout)[<span class="dv">1</span>])) <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>(<span class="ot">NULL</span>)</a>
<a class="sourceLine" id="cb23-46" data-line-number="46">      row &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/match">match</a></span>(done, private<span class="op">$</span>tasks<span class="op">$</span>id)</a>
<a class="sourceLine" id="cb23-47" data-line-number="47">      result &lt;-<span class="st"> </span>private<span class="op">$</span>tasks<span class="op">$</span>result[[row]]</a>
<a class="sourceLine" id="cb23-48" data-line-number="48">      private<span class="op">$</span>tasks &lt;-<span class="st"> </span>private<span class="op">$</span>tasks[<span class="op">-</span>row, ]</a>
<a class="sourceLine" id="cb23-49" data-line-number="49">      <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(result, <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="dt">task_id =</span> done))</a>
<a class="sourceLine" id="cb23-50" data-line-number="50">    }</a>
<a class="sourceLine" id="cb23-51" data-line-number="51">  ),</a>
<a class="sourceLine" id="cb23-52" data-line-number="52"></a>
<a class="sourceLine" id="cb23-53" data-line-number="53">  <span class="dt">private =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(</a>
<a class="sourceLine" id="cb23-54" data-line-number="54">    <span class="dt">tasks =</span> <span class="ot">NULL</span>,</a>
<a class="sourceLine" id="cb23-55" data-line-number="55">    <span class="dt">next_id =</span> 1L,</a>
<a class="sourceLine" id="cb23-56" data-line-number="56">    <span class="dt">get_next_id =</span> <span class="cf">function</span>() {</a>
<a class="sourceLine" id="cb23-57" data-line-number="57">      id &lt;-<span class="st"> </span>private<span class="op">$</span>next_id</a>
<a class="sourceLine" id="cb23-58" data-line-number="58">      private<span class="op">$</span>next_id &lt;-<span class="st"> </span>id <span class="op">+</span><span class="st"> </span>1L</a>
<a class="sourceLine" id="cb23-59" data-line-number="59">      <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">"."</span>, id)</a>
<a class="sourceLine" id="cb23-60" data-line-number="60">    },</a>
<a class="sourceLine" id="cb23-61" data-line-number="61"></a>
<a class="sourceLine" id="cb23-62" data-line-number="62">    <span class="dt">start_workers =</span> <span class="cf">function</span>(concurrency) {</a>
<a class="sourceLine" id="cb23-63" data-line-number="63">      private<span class="op">$</span>tasks &lt;-<span class="st"> </span>tibble<span class="op">::</span><span class="kw"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span>(</a>
<a class="sourceLine" id="cb23-64" data-line-number="64">        <span class="dt">id =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/character">character</a></span>(), <span class="dt">idle =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/logical">logical</a></span>(),</a>
<a class="sourceLine" id="cb23-65" data-line-number="65">        <span class="dt">state =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/c">c</a></span>(<span class="st">"waiting"</span>, <span class="st">"running"</span>, <span class="st">"ready"</span>, <span class="st">"done"</span>)[<span class="ot">NULL</span>],</a>
<a class="sourceLine" id="cb23-66" data-line-number="66">        <span class="dt">fun =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(), <span class="dt">args =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(), <span class="dt">worker =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(), <span class="dt">result =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>())</a>
<a class="sourceLine" id="cb23-67" data-line-number="67">      <span class="cf">for</span> (i <span class="cf">in</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/seq">seq_len</a></span>(concurrency)) {</a>
<a class="sourceLine" id="cb23-68" data-line-number="68">        rs &lt;-<span class="st"> </span>callr<span class="op">::</span>r_session<span class="op">$</span><span class="kw">new</span>(<span class="dt">wait =</span> <span class="ot">FALSE</span>)</a>
<a class="sourceLine" id="cb23-69" data-line-number="69">        private<span class="op">$</span>tasks &lt;-<span class="st"> </span>tibble<span class="op">::</span><span class="kw"><a href="https://tibble.tidyverse.org/reference/add_row.html">add_row</a></span>(private<span class="op">$</span>tasks,</a>
<a class="sourceLine" id="cb23-70" data-line-number="70">          <span class="dt">id =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/paste">paste0</a></span>(<span class="st">".idle-"</span>, i), <span class="dt">idle =</span> <span class="ot">TRUE</span>, <span class="dt">state =</span> <span class="st">"running"</span>,</a>
<a class="sourceLine" id="cb23-71" data-line-number="71">          <span class="dt">fun =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="ot">NULL</span>), <span class="dt">args =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="ot">NULL</span>), <span class="dt">worker =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(rs),</a>
<a class="sourceLine" id="cb23-72" data-line-number="72">          <span class="dt">result =</span> <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/list">list</a></span>(<span class="ot">NULL</span>))</a>
<a class="sourceLine" id="cb23-73" data-line-number="73">      }</a>
<a class="sourceLine" id="cb23-74" data-line-number="74">    },</a>
<a class="sourceLine" id="cb23-75" data-line-number="75"></a>
<a class="sourceLine" id="cb23-76" data-line-number="76">    <span class="dt">schedule =</span> <span class="cf">function</span>() {</a>
<a class="sourceLine" id="cb23-77" data-line-number="77">      ready &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/which">which</a></span>(private<span class="op">$</span>tasks<span class="op">$</span>state <span class="op">==</span><span class="st"> "ready"</span>)</a>
<a class="sourceLine" id="cb23-78" data-line-number="78">      <span class="cf">if</span> (<span class="op">!</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(ready)) <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/function">return</a></span>()</a>
<a class="sourceLine" id="cb23-79" data-line-number="79">      rss &lt;-<span class="st"> </span>private<span class="op">$</span>tasks<span class="op">$</span>worker[ready]</a>
<a class="sourceLine" id="cb23-80" data-line-number="80"></a>
<a class="sourceLine" id="cb23-81" data-line-number="81">      private<span class="op">$</span>tasks<span class="op">$</span>result[ready] &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">lapply</a></span>(rss, <span class="cf">function</span>(x) x<span class="op">$</span><span class="kw">read</span>())</a>
<a class="sourceLine" id="cb23-82" data-line-number="82">      private<span class="op">$</span>tasks<span class="op">$</span>worker[ready] &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">replicate</a></span>(<span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(ready), <span class="ot">NULL</span>)</a>
<a class="sourceLine" id="cb23-83" data-line-number="83">      private<span class="op">$</span>tasks<span class="op">$</span>state[ready] &lt;-</a>
<a class="sourceLine" id="cb23-84" data-line-number="84"><span class="st">        </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/ifelse">ifelse</a></span>(private<span class="op">$</span>tasks<span class="op">$</span>idle[ready], <span class="st">"waiting"</span>, <span class="st">"done"</span>)</a>
<a class="sourceLine" id="cb23-85" data-line-number="85"></a>
<a class="sourceLine" id="cb23-86" data-line-number="86">      waiting &lt;-<span class="st"> </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/which">which</a></span>(private<span class="op">$</span>tasks<span class="op">$</span>state <span class="op">==</span><span class="st"> "waiting"</span>)[<span class="dv">1</span><span class="op">:</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/length">length</a></span>(ready)]</a>
<a class="sourceLine" id="cb23-87" data-line-number="87">      private<span class="op">$</span>tasks<span class="op">$</span>worker[waiting] &lt;-<span class="st"> </span>rss</a>
<a class="sourceLine" id="cb23-88" data-line-number="88">      private<span class="op">$</span>tasks<span class="op">$</span>state[waiting] &lt;-</a>
<a class="sourceLine" id="cb23-89" data-line-number="89"><span class="st">        </span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/ifelse">ifelse</a></span>(private<span class="op">$</span>tasks<span class="op">$</span>idle[waiting], <span class="st">"ready"</span>, <span class="st">"running"</span>)</a>
<a class="sourceLine" id="cb23-90" data-line-number="90">      <span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/lapply">lapply</a></span>(waiting, <span class="cf">function</span>(i) {</a>
<a class="sourceLine" id="cb23-91" data-line-number="91">        <span class="cf">if</span> (<span class="op">!</span><span class="st"> </span>private<span class="op">$</span>tasks<span class="op">$</span>idle[i]) {</a>
<a class="sourceLine" id="cb23-92" data-line-number="92">          private<span class="op">$</span>tasks<span class="op">$</span>worker[[i]]<span class="op">$</span><span class="kw"><a href="https://www.rdocumentation.org/packages/base/topics/call">call</a></span>(private<span class="op">$</span>tasks<span class="op">$</span>fun[[i]],</a>
<a class="sourceLine" id="cb23-93" data-line-number="93">                                         private<span class="op">$</span>tasks<span class="op">$</span>args[[i]])</a>
<a class="sourceLine" id="cb23-94" data-line-number="94">        }</a>
<a class="sourceLine" id="cb23-95" data-line-number="95">      })</a>
<a class="sourceLine" id="cb23-96" data-line-number="96">    }</a>
<a class="sourceLine" id="cb23-97" data-line-number="97">  )</a>
<a class="sourceLine" id="cb23-98" data-line-number="98">)</a></code></pre></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="sidebar">
        <div id="tocnav">
      <h2 class="hasAnchor">
<a href="#tocnav" class="anchor"></a>Contents</h2>
      <ul class="nav nav-pills nav-stacked">
<li><a href="#introduction">Introduction</a></li>
      <li><a href="#api-design">API design</a></li>
      <li><a href="#data-structure">Data structure</a></li>
      <li><a href="#implementation">Implementation</a></li>
      <li><a href="#try-it-out">Try it out</a></li>
      <li><a href="#how-about-process-cleanup">How about process cleanup?</a></li>
      <li><a href="#possible-improvements">Possible improvements</a></li>
      <li><a href="#summary">Summary</a></li>
      <li><a href="#complete-code">Complete code</a></li>
      </ul>
</div>
      </div>

</div>


      <footer><div class="copyright">
  <p>Developed by <a href="https://github.com/gaborcsardi">Gábor Csárdi</a>, <a href="https://github.com/wch">Winston Chang</a>, <a href="https://www.rstudio.com"><img src="https://www.tidyverse.org/rstudio-logo.svg" alt="RStudio" height="24"></a>, Mango Solutions.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.3.0.</p>
</div>
      </footer>
</div>

  

  </body>
</html>
